<!DOCTYPE html>
<html>
<head>
  <title>GPS Rectangle Tracker</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; background: #f3f3f3; }
    canvas { border: 1px solid #333; background: #fff; margin: 10px auto; display: block; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #log { margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Location-Based Rectangle Tracker</h2>
  <button onclick="setPoint1()">Set Point 1</button>
  <button onclick="setPoint2()">Set Point 2</button>
  <button onclick="checkLocation()">Check Location</button>
  <button onclick="clearRectangles()">Clear Rectangles</button>
  <canvas id="mapCanvas" width="400" height="400"></canvas>
  <div id="status"></div>
  <div id="log"></div>

  <script>
    let point1 = null;
    let point2 = null;
    let rectangles = JSON.parse(localStorage.getItem("rectangles") || "[]");
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");

    function setPoint1() {
      navigator.geolocation.getCurrentPosition(pos => {
        point1 = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        };
        alert("Point 1 set!");
      });
    }

    function setPoint2() {
      navigator.geolocation.getCurrentPosition(pos => {
        point2 = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        };
        if (point1) {
          const rect = normalizeRectangle(point1, point2);
          rectangles.push(rect);
          localStorage.setItem("rectangles", JSON.stringify(rectangles));
          drawCanvas();
          alert("Rectangle added!");
        } else {
          alert("Set Point 1 first!");
        }
      });
    }

    function checkLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        const current = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        };
        drawCanvas(current);
        let found = false;
        for (const r of rectangles) {
          if (
            current.lat >= r.minLat &&
            current.lat <= r.maxLat &&
            current.lon >= r.minLon &&
            current.lon <= r.maxLon
          ) {
            document.getElementById("status").innerText = "âœ… Revisited!";
            logVisit(current, "Revisited");
            found = true;
            break;
          }
        }
        if (!found) {
          document.getElementById("status").innerText = "ðŸ†• New Location";
          logVisit(current, "New");
        }
      });
    }

    function normalizeRectangle(p1, p2) {
      return {
        minLat: Math.min(p1.lat, p2.lat),
        maxLat: Math.max(p1.lat, p2.lat),
        minLon: Math.min(p1.lon, p2.lon),
        maxLon: Math.max(p1.lon, p2.lon)
      };
    }

    function drawCanvas(current = null) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const padding = 20;
      const allLats = rectangles.flatMap(r => [r.minLat, r.maxLat]);
      const allLons = rectangles.flatMap(r => [r.minLon, r.maxLon]);
      if (current) {
        allLats.push(current.lat);
        allLons.push(current.lon);
      }

      const minLat = Math.min(...allLats);
      const maxLat = Math.max(...allLats);
      const minLon = Math.min(...allLons);
      const maxLon = Math.max(...allLons);

      function mapX(lon) {
        return ((lon - minLon) / (maxLon - minLon)) * (canvas.width - 2 * padding) + padding;
      }

      function mapY(lat) {
        return ((maxLat - lat) / (maxLat - minLat)) * (canvas.height - 2 * padding) + padding;
      }

      // Draw rectangles
      ctx.strokeStyle = "#007bff";
      ctx.lineWidth = 2;
      rectangles.forEach(r => {
        const x = mapX(r.minLon);
        const y = mapY(r.maxLat);
        const w = mapX(r.maxLon) - x;
        const h = mapY(r.minLat) - y;
        ctx.strokeRect(x, y, w, h);
      });

      // Draw current position
      if (current) {
        const cx = mapX(current.lon);
        const cy = mapY(current.lat);
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, 2 * Math.PI);
        ctx.fill();
      }
    }

    function clearRectangles() {
      rectangles = [];
      localStorage.removeItem("rectangles");
      drawCanvas();
      document.getElementById("status").innerText = "Rectangles cleared.";
    }

    function logVisit(loc, status) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${status} at (${loc.lat.toFixed(5)}, ${loc.lon.toFixed(5)})\n`;
      const logDiv = document.getElementById("log");
      logDiv.innerText = entry + logDiv.innerText;
    }

    drawCanvas(); // Draw on load
  </script>
</body>
</html>
